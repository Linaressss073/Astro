---
import Navbar from "@/components/navbar/navbar.astro";
import Layout from "@/layouts/Layout.astro";

const { search } = Astro.request.url;
const params = new URLSearchParams(search);

// Datos de la reserva
const origen = params.get("origen") ?? "";
const destino = params.get("destino") ?? "";
const fechaSalida = params.get("fechaSalida") ?? "";
const fechaRegreso = params.get("fechaRegreso") ?? "";
const costo = params.get("costo") ?? "0";

// ✅ Función para confirmar la reserva
async function confirmarReserva() {
  // ⚠️ Verificar si estamos en el cliente
  if (typeof window === "undefined") return;

  const token = localStorage.getItem("token");

  if (!token) {
    alert("⚠️ Debes iniciar sesión para reservar.");
    return;
  }

  try {
    const response = await fetch("http://localhost:3001/api/reservas", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`, // Enviar el token
      },
      body: JSON.stringify({
        origen,
        destino,
        fechaSalida,
        fechaRegreso,
        costo: parseFloat(costo),
      }),
    });

    const data = await response.json();

    if (response.ok) {
      alert("✅ Reserva confirmada con éxito.");
      console.log("Reserva creada:", data.reserva);
    } else {
      alert(`❌ Error: ${data.mensaje}`);
    }
  } catch (error) {
    console.error("❌ Error al confirmar la reserva:", error);
    alert("❌ Error en el servidor.");
  }
}
---
<style>
  .reserva-container {
    max-width: 600px;
    margin: 40px auto;
    padding: 24px;
    border: 2px solid #2A0A60;
    border-radius: 16px;
    background: #FAF9FF;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  h3 {
    text-align: center;
    color: #2A0A60;
  }
  .detalle {
    margin: 12px 0;
    font-size: 18px;
  }
  .confirm-btn {
    width: 100%;
    padding: 12px;
    background: #5A32A3;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    cursor: pointer;
  }
  .confirm-btn:hover {
    background: #2A0A60;
  }
</style>

<Layout>
  <div class="reserva-container">
    <h3>📋 Detalles de tu Reserva</h3>
    <p class="detalle">✈️ <strong>Origen:</strong> {origen}</p>
    <p class="detalle">🏝️ <strong>Destino:</strong> {destino}</p>
    <p class="detalle">📅 <strong>Fecha de salida:</strong> {fechaSalida}</p>
    <p class="detalle">📆 <strong>Fecha de regreso:</strong> {fechaRegreso}</p>
    <p class="detalle">💰 <strong>Costo:</strong> ${costo} USD</p>

    <button class="confirm-btn" on:click={confirmarReserva}>
      Confirmar Reserva
    </button>
  </div>
</Layout>
